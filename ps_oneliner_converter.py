# This is a quick and dirty script for converting obfuscated PowerShell oneliner scripts into multiline scripts
# for the purpose of reading them more easily. It does not take into account the posibility that squiqqly brackets
# etc could be contained in quotes, as this is almost never going to be the case in obfuscated PowerShell scripts.
# The user can select which special characters to convert - regular brackets, squiggly brackets, and/or semi-colons.
# This choice is important because sometimes only converting certain characters is helpful.

from argparse import ArgumentParser
import os

parser = ArgumentParser('Converter for PowerShell Oneliners', 'Convert a PowerShell oneliner to a multiline script.', exit_on_error=True)
parser.add_argument('-f', '--filepath', type=os.path.abspath, required=True, help='File with PowerShell Oneliner')
parser.add_argument('-r', '--regular', action='store_true', required=False, help='Whether regular brackets should be used to break up lines.')
parser.add_argument('-s', '--squiggly', action='store_true', required=False, help='Whether squiggly brackets should be used to break up lines.')
parser.add_argument('-sc', '--semi_colon', action='store_true', required=False, help='Whether semi-colons should be used to break up lines.')
args = parser.parse_args()

if args.regular is False and args.squiggly is False and args.semi_colon is False:
   parser.error("at least one of --regular, --squiggly or --semi_colon is required")

filepath = args.filepath
filetowrite = filepath.split('.')[0] + '_converted.' + filepath.split('.')[-1]

opening = []
closing = []

if args.regular:
	opening.append('(')
	closing.append(')')
if args.squiggly:
	opening.append('{')
	closing.append('}')


# we need to keep count of the number of open squiggly brackets, as each one
# means we need to indent the following code once
squiggly_count = 0

with open(filepath, 'r') as fileread:
	with open(filetowrite, 'w') as filewrite:
		for line in fileread:
			for i, c in enumerate(line):
				# for each opening squiqqly bracket, print it, then increment the bracket count
				# and print a new line and the correct number of tabs
				if c in opening:
					filewrite.write(c)
					squiggly_count += 1
					filewrite.write('\n' + squiggly_count * '\t')
					continue
				# for each closing squiqqly bracket, decrement the bracket count,
				# print a new line and the correct number of tabs, then the bracket
				elif c in closing:
					squiggly_count -= 1
					filewrite.write('\n' + squiggly_count * '\t')
					filewrite.write(c)
					continue
				# for each semicolon, print it followed by a new line and the correct number of tabs
				elif args.semi_colon and c == ';':
					filewrite.write(c)
					filewrite.write('\n' + squiggly_count * '\t')
					continue
				# for each space, if it follows a semicolon, do not print it. This is because it will
				# mess up the indentation
				elif args.semi_colon and c == ' ':
					if line[i - 1] == ';':
						continue
				filewrite.write(c)
				continue
		filewrite.close()
		fileread.close()